# .github/workflows/main.yml
name: Deploy to DigitalOcean

on:
  push:
    branches: ["main"]

jobs:
  test_and_build_client:
    name: Test & Build Client
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies (client)
        working-directory: ./quickvisa-client
        run: |
          npm ci

      - name: Lint (Test) client
        working-directory: ./quickvisa-client
        run: |
          npm run lint

      - name: Build client
        working-directory: ./quickvisa-client
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
          VITE_API_BASE_URL: ${{ secrets.API_BASE_URL }}
        run: |
          npm run build

      - name: Upload client build artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: ./quickvisa-client/dist

  deploy_client:
    name: Deploy Client
    needs: test_and_build_client
    runs-on: ubuntu-latest
    steps:
      - name: Download client build artifact
        uses: actions/download-artifact@v4
        with:
          name: client-build
          path: ./dist

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          known_hosts: unnecessary_due_to_flag
          if_key_exists: replace

      - name: Deploy client via rsync
        run: |
          rsync -avz --delete --timeout=600 \
            -e "ssh -p ${{ secrets.DO_SSH_PORT }} \
                -o StrictHostKeyChecking=no \
                -o ServerAliveInterval=15 \
                -o ServerAliveCountMax=10" \
            ./dist/ ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }}:${{ secrets.DO_CLIENT_DIR }}

      - name: Restart pm2 service
        run: |
          ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }} 'sudo pm2 restart quickvisa-app'

  test_and_deploy_api:
    name: Test & Deploy API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies (api)
        working-directory: ./quickvisa-api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file for API
        working-directory: ./quickvisa-api
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > .env
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
          echo "FERNET_KEY=${{ secrets.FERNET_KEY }}" >> .env

      - name: Archive API for transfer
        run: |
          tar -czf api-deploy.tar.gz -C ./quickvisa-api .

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          known_hosts: unnecessary_due_to_flag
          if_key_exists: replace

      - name: Send API archive to server
        run: |
          ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }} "mkdir -p ${{ secrets.DO_API_DIR }}"
          scp -P ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no api-deploy.tar.gz ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }}:${{ secrets.DO_API_DIR }}/

      - name: Remote deploy API
        run: |
          ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }} '
            set -e
            cd ${{ secrets.DO_API_DIR }}
            tar -xzf api-deploy.tar.gz -C .
            rm api-deploy.tar.gz
            
            python3 -m venv .venv || true
            source .venv/bin/activate
            pip3 install --upgrade pip
            pip3 install -r requirements.txt
            
            sudo pm2 restart quickvisa-api || echo "Service not found"
          '
