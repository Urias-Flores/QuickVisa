# .github/workflows/main.yml
name: Deploy to DigitalOcean

on:
  push:
    branches: ["main"]

jobs:
  test_and_build_client:
    name: Test & Build Client
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies (client)
        working-directory: ./quickvisa-client
        run: |
          npm ci

      - name: Lint (Test) client
        working-directory: ./quickvisa-client
        run: |
          npm run lint

      - name: Build client
        working-directory: ./quickvisa-client
        run: |
          npm run build

      - name: Upload client build artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: ./quickvisa-client/dist

  deploy_client:
    name: Deploy Client
    needs: test_and_build_client
    runs-on: ubuntu-latest
    steps:
      - name: Download client build artifact
        uses: actions/download-artifact@v4
        with:
          name: client-build
          path: ./dist

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Deploy client via rsync
        run: |
          for i in {1..3}; do
            if sshpass -p "${{ secrets.DO_SSH_PASSWORD }}" rsync -avz --delete --timeout=300 --partial -e "ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no -o ServerAliveInterval=15 -o ServerAliveCountMax=5 -o ConnectTimeout=30" ./dist/ ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }}:${{ secrets.DO_CLIENT_DIR }}; then
              echo "rsync succeeded"
              break
            else
              if [ $i -lt 3 ]; then
                echo "rsync attempt $i failed, retrying in 5 seconds..."
                sleep 5
              else
                echo "rsync failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Restart pm2 service
        run: |
          sshpass -p "${{ secrets.DO_SSH_PASSWORD }}" ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }} 'sudo pm2 restart quickvisa-app'

  test_and_deploy_api:
    name: Test & Deploy API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies (api)
        working-directory: ./quickvisa-api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Archive API for transfer
        run: |
          tar -czf api-deploy.tar.gz -C ./quickvisa-api .

      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      - name: Send API archive to server
        run: |
          # Ensure remote directory exists
          sshpass -p "${{ secrets.DO_SSH_PASSWORD }}" ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=5 ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }} "mkdir -p ${{ secrets.DO_API_DIR }}"

          # Transfer with retry logic
          for i in {1..3}; do
            if sshpass -p "${{ secrets.DO_SSH_PASSWORD }}" scp -C -P ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=5 quickvisa-api/api-deploy.tar.gz ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }}:${{ secrets.DO_API_DIR }}/; then
              echo "SCP succeeded"
              break
            else
              if [ $i -lt 3 ]; then
                echo "SCP attempt $i failed, retrying in 5 seconds..."
                sleep 5
              else
                echo "SCP failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Remote deploy API
        run: |
          sshpass -p "${{ secrets.DO_SSH_PASSWORD }}" ssh -p ${{ secrets.DO_SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.DO_SSH_USER }}@${{ secrets.DO_SERVER_HOST }} '
            set -e
            cd ${{ secrets.DO_API_DIR }}
            tar -xzf api-deploy.tar.gz -C .
            rm api-deploy.tar.gz
            
            # Create/activate venv and install dependencies
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            source .venv/bin/activate
            pip install -r requirements.txt
            
            # Restart service (assuming pm2 service named quickvisa-api)
            # You might need to adjust the service name
            sudo pm2 restart quickvisa-api || echo "Service quickvisa-api not found or failed to restart. Please check server configuration."
          '
